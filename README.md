# üìä Analyse de la Sant√© Financi√®re des Communes

> **Application de diagnostic financier professionnelle** bas√©e sur le scoring V3 adaptatif pour les collectivit√©s locales.

![Python](https://img.shields.io/badge/Python-3.8%2B-blue)
![Streamlit](https://img.shields.io/badge/Streamlit-1.0%2B-red)
![License](https://img.shields.io/badge/License-MIT-green)
![Status](https://img.shields.io/badge/Status-Active-brightgreen)

---

## üéØ Objectifs

Fournir une analyse compl√®te et comparative de la sant√© financi√®re des communes fran√ßaises :

- **Scoring automatis√©** (0-100) bas√© sur 4 indicateurs cl√©s
- **Comparaison avec la strate officielle** de chaque commune
- **D√©tection d'anomalies** et identification des risques
- **Visualisations interactives** et rapports PDF professionnels
- **Export de donn√©es** en Excel/CSV pour analyses personnalis√©es

---

## üöÄ D√©marrage Rapide

### Installation

```bash
# Cloner le repository
git clone <repository-url>
cd analyse-communes-finances

# Cr√©er un environnement virtuel
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate  # Windows

# Installer les d√©pendances
pip install -r requirements.txt
```

### Lancer l'application

```bash
streamlit run claude.py
```

L'application s'ouvre automatiquement sur `http://localhost:8501`

---

## üìã Fonctionnalit√©s Principales

### 1. **Analyse D√©partementale** üèòÔ∏è

- S√©lection du d√©partement et de l'ann√©e
- Filtrage par population minimale
- Tableau de bord avec m√©triques agr√©g√©es
- Graphiques interactifs (Plotly)

**KPIs affich√©s :**
- Nombre de communes analys√©es
- Score moyen de sant√©
- Population totale
- Pourcentage de communes fragiles

### 2. **Scoring V3 Adaptatif** üéØ

Syst√®me de scoring propri√©taire sur 100 points :

| Composante | Pond√©ration | Seuil Vert | Seuil Orange | Seuil Rouge |
|-----------|-------------|-----------|------------|-----------|
| **TEB** (Taux d'√âpargne Brute) | 20% | > 15% | 10-15% | < 10% |
| **CD** (Capacit√© D√©sendettement) | 30% | < 8 ans | 8-12 ans | > 12 ans |
| **Annuit√©/CAF** | 30% | < 50% | 50-60% | > 60% |
| **FDR** (Fonds de Roulement) | 20% | > 240j | 60-240j | < 60j |

**Score Global :** 
- üü¢ **Vert** : 75-100 (Situation saine)
- üü† **Orange** : 50-75 (√Ä surveiller)
- üî¥ **Rouge** : 0-50 (Fragile)

### 3. **Visualisations Interactives** üìä

#### Graphiques Statistiques
- **Pie Chart** : R√©partition des niveaux d'alerte
- **Histogramme** : Distribution des scores
- **Scatter Plots** : Comparaisons multidimensionnelles
- **Box Plots** : Analyses par cat√©gories

#### Graphiques Sp√©cialis√©s
- **Radar Coh√©rent** : Profil financier 360¬∞
- **Score Evolution** : Tendance pluriannuelle
- **Stacked Bar** : Contribution des composantes
- **Lignes D√©taill√©es** : √âvolution de chaque indicateur

### 4. **Analyse Commune D√©taill√©e** üîç

S√©lectionner une commune pour acc√©der √† :

- **Donn√©es consolid√©es** : Tous les KPIs
- **Radar comparatif** : Versus strate officielle
- **Historique pluriannuel** : 2019-2024
- **Tableau de normalisation** : Transformation des donn√©es
- **Graphiques individuels** : 4 indicateurs distincts

### 5. **Export Professionnel** üìÑ

#### PDF Complet
Rapport g√©n√©r√© avec :
- ‚úÖ Page de garde personnalis√©e
- ‚úÖ Synth√®se ex√©cutive
- ‚úÖ Indicateurs cl√©s (tableau)
- ‚úÖ Profil radar
- ‚úÖ Graphiques pluriannuels (6 pages min.)
- ‚úÖ Tableaux r√©capitulatifs
- ‚úÖ En-t√™tes et pieds de page

#### Excel/CSV
- Tableau complet avec formatage conditionnel
- Feuille "Synth√®se" avec agr√©gations
- Codage couleur par niveau d'alerte

### 6. **Classements Top/Flop** üèÜ

- **Top 25 Fragiles** : Communes avec score ‚â§ P25
- **Top 25 Solides** : Communes avec score ‚â• P75
- Colonnes affich√©es : Commune, Population, Score, TEB, CD, Annuit√©/CAF, FDR

---

## üîß Architecture Technique

### Stack Technologique

```
Frontend     : Streamlit
Backend      : Python 3.8+
Visualisation: Plotly, Matplotlib, Seaborn
Donn√©es      : Pandas, NumPy
API          : data.economie.gouv.fr
Export       : ReportLab (PDF), openpyxl (Excel)
```

### Structure du Code

```
claude.py
‚îú‚îÄ‚îÄ Configuration Streamlit
‚îú‚îÄ‚îÄ Classes & Fetchers
‚îÇ   ‚îî‚îÄ‚îÄ RobustCommuneFetcher
‚îú‚îÄ‚îÄ Fonctions API
‚îÇ   ‚îú‚îÄ‚îÄ fetch_communes()
‚îÇ   ‚îî‚îÄ‚îÄ fetch_historical_commune_data()
‚îú‚îÄ‚îÄ Calculs KPI
‚îÇ   ‚îú‚îÄ‚îÄ score_sante_financiere_v3()
‚îÇ   ‚îú‚îÄ‚îÄ niveau_alerte_v3()
‚îÇ   ‚îî‚îÄ‚îÄ calculate_historical_kpis()
‚îú‚îÄ‚îÄ Visualisations
‚îÇ   ‚îú‚îÄ‚îÄ Plotly (interactif)
‚îÇ   ‚îú‚îÄ‚îÄ Matplotlib/Seaborn (PDF)
‚îÇ   ‚îî‚îÄ‚îÄ Radar coh√©rent
‚îú‚îÄ‚îÄ Export
‚îÇ   ‚îú‚îÄ‚îÄ generate_pdf_graphs()
‚îÇ   ‚îî‚îÄ‚îÄ export_commune_analysis_to_pdf_enhanced()
‚îî‚îÄ‚îÄ UI/Dashboards
    ‚îú‚îÄ‚îÄ Tableau de bord principal
    ‚îú‚îÄ‚îÄ Analyse d√©taill√©e
    ‚îî‚îÄ‚îÄ Classements
```

### Flux de Donn√©es

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ S√©lection Dept + Ann√©e + Filtres        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API data.economie.gouv.fr            ‚îÇ
‚îÇ (get_api_url_for_year)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Traitement Donn√©es                   ‚îÇ
‚îÇ ‚Ä¢ Nettoyage                          ‚îÇ
‚îÇ ‚Ä¢ Calcul TEB, CD, Annuit√©/CAF, FDR   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Calcul Scoring V3                    ‚îÇ
‚îÇ ‚Ä¢ Normalisation                      ‚îÇ
‚îÇ ‚Ä¢ Pond√©ration (20/30/30/20)          ‚îÇ
‚îÇ ‚Ä¢ Classification (Vert/Orange/Rouge) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Visualisations & Export              ‚îÇ
‚îÇ ‚Ä¢ Dashboards interactifs             ‚îÇ
‚îÇ ‚Ä¢ PDF professionnel                  ‚îÇ
‚îÇ ‚Ä¢ Fichiers Excel/CSV                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Indicateurs Financiers Expliqu√©s

### 1. TEB (Taux d'√âpargne Brute) - 20 pts
**Formule** : `CAF Brute / Recettes R√©elles Fonctionnement √ó 100`

Mesure la capacit√© de la commune √† d√©gager de l'√©pargne apr√®s fonctionnement.
- ‚úÖ **Bon** : > 15% (d√©gagement substantiel)
- ‚ö†Ô∏è **√Ä surveiller** : 8-15% (capacit√© mod√©r√©e)
- ‚ùå **Critique** : < 8% (tr√®s limit√©)

### 2. CD (Capacit√© D√©sendettement) - 30 pts
**Formule** : `Encours Dettes / CAF Brute` (en ann√©es)

Temps n√©cessaire pour rembourser la dette avec l'√©pargne annuelle.
- ‚úÖ **Bon** : < 8 ans (d√©sendettement rapide)
- ‚ö†Ô∏è **√Ä surveiller** : 8-12 ans (mod√©r√©)
- ‚ùå **Critique** : > 12 ans (endettement √©lev√©)

### 3. Annuit√©/CAF - 30 pts
**Formule** : `Annuit√© Remboursement / CAF Brute √ó 100`

Part des remboursements dans l'√©pargne disponible.
- ‚úÖ **Bon** : < 50% (√©pargne lib√©r√©e)
- ‚ö†Ô∏è **√Ä surveiller** : 50-60% (√©pargne consomm√©e)
- ‚ùå **Critique** : > 60% (surengagement)

### 4. FDR (Fonds de Roulement) - 20 pts
**Formule** : `(FDR ‚Ç¨ par habitant / DRF ‚Ç¨ par habitant) √ó 365` (en jours)

Jours de fonctionnement garantis par la tr√©sorerie.
- ‚úÖ **Bon** : > 240 jours (~8 mois)
- ‚ö†Ô∏è **√Ä surveiller** : 60-240 jours
- ‚ùå **Critique** : < 60 jours (~2 mois)

---

## üé® Utilisateur Guide

### Mode Analyse Rapide

1. **Barre lat√©rale** : S√©lectionner D√©partement + Ann√©e
2. **Bouton bleu** : "Analyser le d√©partement"
3. **R√©sultats** : M√©triques + Graphiques interactifs

### Mode D√©taill√©

1. S√©lectionner une commune dans la liste
2. **Tabs** disponibles :
   - üìä Score Global (√©volution)
   - üì¶ Stacked Bar (contribution)
   - üìà Lignes (d√©tails par composante)
3. **Export** : Cliquer "G√©n√©rer Rapport PDF"

### Mode Debug

Cocher üî¨ "Mode Debug FDR" pour voir :
- Diagnos FDR d√©partement
- Valeurs aberrantes
- Statistiques globales

---

## üìà Cas d'Usage

### Pour les Collectivit√©s
‚úÖ Diagnostiquer sa situation financi√®re
‚úÖ Comparer sa performance √† la strate
‚úÖ Identifier les points √† am√©liorer
‚úÖ G√©n√©rer des rapports de synth√®se

### Pour les Contr√¥leurs de Gestion
‚úÖ Analyser plusieurs communes rapidement
‚úÖ D√©tecter les anomalies
‚úÖ Pr√©parer des benchmarks
‚úÖ Exporter pour analyses approfondies

### Pour les √âlus
‚úÖ Pr√©senter la situation financi√®re (PDF)
‚úÖ Communiquer sur le score
‚úÖ Justifier les d√©cisions d'investissement

---

## ‚öôÔ∏è Configuration & Param√©trage

### Donn√©es Disponibles

```python
DATASETS_MAPPING = {
    2019: "...2019-2020",
    2020: "...2019-2020",
    2021: "...2021",
    2022: "...2022",
    2023: "...2023-2024",
    2024: "...2023-2024"
}
```

### Seuils Personnalisables

Pour modifier les seuils, √©diter les fonction :
- `score_sante_financiere_v3()` : Scoring
- `normaliser_indicateurs_pour_radar()` : Plages de normalisation

### API & Rate Limiting

- **Endpoint** : `data.economie.gouv.fr/api/explore/v2.1`
- **Pagination** : 100 records par appel
- **Cache** : 3600 secondes (1 heure)

---

## üêõ Troubleshooting

### ‚ö†Ô∏è "Aucune donn√©e trouv√©e"
‚Üí V√©rifier que le d√©partement/ann√©e existe
‚Üí V√©rifier la connexion Internet
‚Üí Consulter le Mode Debug

### ‚ö†Ô∏è "FDR invalide (>1000 jours)"
‚Üí Donn√©es aberrantes plafonn√©es √† `pd.NA`
‚Üí Normal pour petites communes
‚Üí Affichage : üî¨ Mode Debug

### ‚ö†Ô∏è "PDF g√©n√©r√© vide"
‚Üí V√©rifier qu'au moins 2 ann√©es historiques sont disponibles
‚Üí Graphiques individuels g√©n√©r√©s OK (check)

---

## üîê S√©curit√© & Conformit√©

- ‚úÖ Pas de stockage de donn√©es personnelles
- ‚úÖ API publique (data.economie.gouv.fr)
- ‚úÖ Donn√©es anonymis√©es au niveau communes
- ‚úÖ Cache local (session Streamlit)
- ‚úÖ Pas de base de donn√©es externe

---

## üì¶ D√©pendances

```
streamlit>=1.28.0
pandas>=1.3.0
numpy>=1.21.0
requests>=2.28.0
plotly>=5.0.0
matplotlib>=3.5.0
seaborn>=0.12.0
reportlab>=4.0.0
scipy>=1.7.0
openpyxl>=3.8.0
```

Installer tout :
```bash
pip install -r requirements.txt
```

---

## üöÄ Optimisations Futures

- [ ] Import de fichiers personnalis√©s
- [ ] Pr√©dictions ML (tendances futures)
- [ ] Comparaisons inter-r√©gionales
- [ ] Alertes automatiques (mail)
- [ ] API REST pour int√©grations externes
- [ ] Dashboard temps r√©el

---

## üìû Support & Contribution

### Signaler un bug
Cr√©er une **Issue** avec :
- D√©partement + Ann√©e
- Description du probl√®me
- Capture d'√©cran si possible

### Proposer une am√©lioration
Cr√©er une **Pull Request** avec :
- Description claire
- Tests unitaires
- Documentation

---

## üìÑ Licence

MIT License

---

## üë• Auteur

**Arthur Bodin pour SFP COLLECTIVIT√âS**
Diagnostic financier pour collectivit√©s territoriales

---

## üéì Ressources

- üìñ [Documentation API data.gouv](https://data.economie.gouv.fr/)
- üìä [Guide Finances Locales](https://www.collectivites-territoriales.gouv.fr/)
- üî¢ [Indicateurs DGCL](https://www.dgcl.gouv.fr/)

---

## ‚ú® Points Forts

- üéØ **Scoring scientifique** : Bas√© sur 4 KPIs reconnus
- üåç **Donn√©es officielles** : API gouvernementale
- üìä **Visualisations** : 10+ graphiques interactifs
- üìÑ **Export pro** : PDF/Excel de haute qualit√©
- üîç **D√©tail** : Historique 6 ans + radar comparatif
- ‚ö° **Perfo** : Cache intelligent, requ√™tes optimis√©es
- üé® **UX** : Interface intuitive Streamlit
- üîß **Maintenable** : Code modulaire et document√©

---

**Derni√®re mise √† jour** : 2024
**Version** : 3.0 (Scoring V3 adaptatif)